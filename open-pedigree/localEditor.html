<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Open Pedigree by PhenoTips&reg;</title>

    <!-- Load jquery before prototype, making it available via jQuery but not $ -->
    <script type="text/javascript" src="public/vendor/jquery-3.4.1.min.js"></script>

    <!-- PrototypeJS and scriptaculous plugin -->
    <script type="text/javascript" src="public/vendor/prototype-1.7.3.js"></script>
    <script type="text/javascript" src="public/vendor/scriptaculous/effects.js"></script>
    <script type="text/javascript" src="public/vendor/scriptaculous/dragdrop.js"></script>
    <script type="text/javascript" src="public/vendor/scriptaculous/slider.js"></script>

    <!-- File download -->
    <script type="text/javascript" src="public/vendor/filesaver/Blob.js"></script>
    <script type="text/javascript" src="public/vendor/filesaver/FileSaver.js"></script>
    <script type="text/javascript" src="public/vendor/URI.js"></script>

    <!-- PDF libraries -->
    <script type="text/javascript" src="public/vendor/pdfkit/pdfkit.standalone.js"></script>
    <script type="text/javascript" src="public/vendor/pdfkit/svg-to-pdfkit.js"></script>
    <script type="text/javascript" src="public/vendor/pdfkit/blob-stream.js"></script>

    <!-- XWiki REST API and widgets -->
    <script type="text/javascript" src="public/vendor/xwiki/xwiki-min.js"></script>
    <script type="text/javascript" src="public/vendor/phenotips/Widgets.js"></script>
    <script type="text/javascript" src="public/vendor/phenotips/DateTimePicker.js"></script>
    <script type="text/javascript" src="public/vendor/selectize/selectize.js"></script>

    <!-- Open Pedigree bundle -->
    <script type="text/javascript" src="dist/pedigree.min.js"></script>

  </head>

  <body id='body'>
  <script type="text/javascript">

    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
              results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    };

    var editor;

    document.observe('dom:loaded',function() {
      var redcapTerminolgyUrl = getParameterByName('redcapTerminolgyUrl');
      if (redcapTerminolgyUrl){

        var mode = getParameterByName('mode');
        if (mode === 'SCT') {
          OpenPedigree.setREDCapFHIRTerminology('disorder', redcapTerminolgyUrl, 'http://snomed.info/sct',
                  'http://snomed.info/sct?fhir_vs=refset/32570581000036105', /[0-9]+/, 20);
          OpenPedigree.setREDCapFHIRTerminology('phenotype', redcapTerminolgyUrl, 'http://snomed.info/sct',
                  'http://ga4gh.org/fhir/ValueSet/phenotype', /[0-9]+/, 20);
          OpenPedigree.setREDCapFHIRTerminology('gene', redcapTerminolgyUrl, 'http://www.genenames.org/geneId',
                  'http://www.genenames.org/geneId?vs', /^HGNC:/, 20);
        }
        else if (mode === 'CUSTOM'){
          var disorderSystem = getParameterByName('disorderSystem');
          var disorderValueset = getParameterByName('disorderValueset');
          var disorderRegex = getParameterByName('disorderRegex');
          OpenPedigree.setREDCapFHIRTerminology('disorder', redcapTerminolgyUrl, disorderSystem,
                  disorderValueset, new RegExp(disorderRegex), 20);

          var phenotypeSystem = getParameterByName('phenotypeSystem');
          var phenotypeValueset = getParameterByName('phenotypeValueset');
          var phenotypeRegex = getParameterByName('phenotypeRegex');
          OpenPedigree.setREDCapFHIRTerminology('phenotype', redcapTerminolgyUrl, phenotypeSystem,
                  phenotypeValueset,  new RegExp(phenotypeRegex), 20);

          var geneSystem = getParameterByName('geneSystem');
          var geneValueset = getParameterByName('geneValueset');
          var geneRegex = getParameterByName('geneRegex');
          OpenPedigree.setREDCapFHIRTerminology('gene', redcapTerminolgyUrl, geneSystem,
                  geneValueset, new RegExp(geneRegex), 20);
        }
        else {
          OpenPedigree.setREDCapFHIRTerminology('disorder', redcapTerminolgyUrl, 'http://www.omim.org',
                  'http://www.omim.org?vs', /[0-9]+/, 20);
          OpenPedigree.setREDCapFHIRTerminology('phenotype', redcapTerminolgyUrl, 'http://purl.obolibrary.org/obo/hp.fhir',
                  'http://purl.obolibrary.org/obo/hp.fhir?vs', /^(http:\/\/)|(HP:)/, 20);
          OpenPedigree.setREDCapFHIRTerminology('gene', redcapTerminolgyUrl, 'http://www.genenames.org/geneId',
                  'http://www.genenames.org/geneId?vs', /^HGNC:/, 20);
        }
      }
      else {
        var ontologyServer = getParameterByName('ontologyServer') || 'https://r4.ontoserver.csiro.au/fhir/';

        var mode = getParameterByName('mode');
        if (mode === 'SCT') {
          OpenPedigree.setFHIRTerminology('disorder', ontologyServer, 'http://snomed.info/sct',
                  'http://snomed.info/sct?fhir_vs=refset/32570581000036105', /[0-9]+/, 20);
          OpenPedigree.setFHIRTerminology('phenotype', ontologyServer, 'http://snomed.info/sct',
                  'http://ga4gh.org/fhir/ValueSet/phenotype', /[0-9]+/, 20);
          OpenPedigree.setFHIRTerminology('gene', ontologyServer, 'http://www.genenames.org/geneId',
                  'http://www.genenames.org/geneId?vs', /^HGNC:/, 20);
        }
        else if (mode === 'CUSTOM'){
          var disorderSystem = getParameterByName('disorderSystem');
          var disorderValueset = getParameterByName('disorderValueset');
          var disorderRegex = getParameterByName('disorderRegex');
          OpenPedigree.setREDCapFHIRTerminology('disorder', ontologyServer, disorderSystem,
                  disorderValueset, new RegExp(disorderRegex), 20);

          var phenotypeSystem = getParameterByName('phenotypeSystem');
          var phenotypeValueset = getParameterByName('phenotypeValueset');
          var phenotypeRegex = getParameterByName('phenotypeRegex');
          OpenPedigree.setREDCapFHIRTerminology('phenotype', ontologyServer, phenotypeSystem,
                  phenotypeValueset,  new RegExp(phenotypeRegex), 20);

          var geneSystem = getParameterByName('geneSystem');
          var geneValueset = getParameterByName('geneValueset');
          var geneRegex = getParameterByName('geneRegex');
          OpenPedigree.setREDCapFHIRTerminology('gene', ontologyServer, geneSystem,
                  geneValueset, new RegExp(geneRegex), 20);
        }
        else {
          OpenPedigree.setFHIRTerminology('disorder', ontologyServer, 'http://www.omim.org',
                  'http://www.omim.org?vs', /[0-9]+/, 20);
          OpenPedigree.setFHIRTerminology('phenotype', ontologyServer, 'http://purl.obolibrary.org/obo/hp.fhir',
                  'http://purl.obolibrary.org/obo/hp.fhir?vs', /^(http:\/\/)|(HP:)/, 20);
          OpenPedigree.setFHIRTerminology('gene', ontologyServer, 'http://www.genenames.org/geneId',
                  'http://www.genenames.org/geneId?vs', /^HGNC:/, 20);
        }
      }

      var qData = getParameterByName('qData');

      var format = getParameterByName('format') || 'fhir';
      if (format === ''){
        format = 'fhir';
      }

      console.log("creating editor");

      var editorOptions = {patientDataUrl: 'local:pedigreeData?format='+format+'&closeOnSave=true',
                           returnUrl: '#CloseWindow'};


      editor = OpenPedigree.initialiseEditor(editorOptions);

    });
  </script>
  </body>
</html>
